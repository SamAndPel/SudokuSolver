<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="styles.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="tile.js"></script>
        <script src="sudokuGrid.js"></script>
        <title>JS Sudoku Solver</title>
    </head>

    <body>

        <div id="flex-space">

            <div id="loadmodal" class="modal">
                <div class="modalcontent">
                    <div class="modalheader">
                        <span class="modalclose" onclick="closeModals()">&times;</span>
                        <h2>Load Sudoku</h2>
                    </div>
                    <div class="modalbody">
                        <p>Enter Sudoku data below:</p>
                        <textarea onfocus="this.select()" id="loadtext" placeholder="JSON (array of 9 arrays, each of length 9) or numeric (number 0-9 for each square)" autofocus></textarea>
                        <button type="button" class="loadbtn" onclick="getinput()">Load</button>
                    </div>
                </div>
            </div>

            <div id="exportmodal" class="modal">
                <div class="modalcontent">
                    <div class="modalheader">
                        <span class="modalclose" onclick="closeModals()">&times;</span>
                        <h2>Export Sudoku</h2>
                    </div>
                    <div class="modalbody">
                        <div id="expmodalbody">
                            <div class="itemcol">
                                <p>Image:</p>
                                <img src="" id="imgexport" alt="Image of Sudoku puzzle">
                            </div>
                            <div class="itemcol">
                                <p>JSON:</p>
                                <textarea onfocus="this.select()" id="jsonexport"></textarea>
                            </div>
                            <div class="itemcol">
                                <p>Numeric:</p>
                                <textarea onfocus="this.select()" id="numericexport"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="output">
                <canvas id="myCanvas" width="900" height="900"></canvas>
            </div>
            <div id="controllers">
                <h1>JS Sudoku Solver</h1>
                <p class="centerme">Some importable Sudokus <a href="https://www.kaggle.com/bryanpark/sudoku" target="_blank">on Kaggle</a></p>
                <div class="itemrow centerme">
                    <p>Status:&nbsp;</p>
                    <p id="status"></p>
                </div>
                <div id="buttons">
                    <div class="itemrow">
                        <button type="button" id="solvebtn" onclick="solve()">Solve</button>
                        <button type="button" id="stopbtn" onclick="stop(false)" disabled>Stop</button>
                    </div>
                    <div class="itemrow">
                        <button type="button" id="loadbtn" class="loadbtn" onclick="loadgrid()">Import</button>
                        <button type="button" id="exportbtn" class="exportbtn" onclick="exportgrid()">Export</button>
                    </div>
                    <div class="itemrow">
                        <button type="button" id="clearbtn" onclick="clearattempt()" disabled>Clear attempt</button>
                    </div>
                    <div class="itemrow">
                        <button type="button" id="clearallbtn" onclick="clearall()">Clear all</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // TODO:
            //   - Refactor main html file, make it less monolithic
            //   - Refactor isValid Fx in grid class - does it really need to process each box individually?
            //   - Find next solution (find all solutions?)
            //   - Generate new sudoku?

            // UTILITY FUNCTIONS -----------
            function closeModals() {
                document.getElementById("loadmodal").style.display = "none";
                document.getElementById("exportmodal").style.display = "none";
                console.log("[-] Modal closed");
            }

            function setButtons(start, stop, loadgrid, exportgrid, clear, clearall) {
                document.getElementById("solvebtn").disabled = start;
                document.getElementById("stopbtn").disabled = stop;
                document.getElementById("loadbtn").disabled = loadgrid;
                document.getElementById("exportbtn").disabled = exportgrid;
                document.getElementById("clearbtn").disabled = clear;
                document.getElementById("clearallbtn").disabled = clearall;
            }

            function setStatus(message) {
                document.getElementById("status").innerHTML = message;
            }

            function getIndex(x, y) {
                if ((x >= 0) && (x < 9) && (y >= 0) && (y < 9)) {
                    return ((y * 9) + x);
                } else {
                    return -1;
                }
            }

            function isNumeric(value) {
                return /^\d+$/.test(value);
            }

            function validateJSON(str) {
                // Is the data actually JSON?
                try {
                    const data = JSON.parse(str);
                    // Is it nine indices long?
                    if (data.length === 9) {
                        for (var i = 0; i < data.length; i++) {
                            // is each index an array of length 9?
                            if (data[i].length === 9) {
                                for (var j = 0; j < data[i].length; j++) {
                                    // Is the contents of that array 9 ints 0 <= x < 10 ?
                                    if (isNumeric(data[i][j]) && data[i][j] >= 0 && data[i][j] <= 9) {
                                        // its valid, do nothing
                                        continue;
                                    } else {
                                        return false;
                                    }
                                }
                            } else {
                                return false;
                            }
                        }
                    } else {
                        return false;
                    }
                } catch (e) {
                    return false;
                }
                return true;
            }

            function validateNumeric(str) {
                if (str.length === 81 && isNumeric(str)) {
                    return true;
                } else {
                    return false;
                }
            }

            function loaddata(dataarr) {
                console.log("[*] Sudoku loaded");
                initialise(true);
                for (var i = 0; i < dataarr.length; i++) {
                    master.data[i].value = parseInt(dataarr[i]);
                    if (parseInt(dataarr[i]) !== 0) {
                        master.data[i].mutable = false;
                    }
                }
                setButtons(false, true, false, false, true, false);
                master.render();
            }

            function loadInitial() {
                const initialstr = "090046025002970000670000009301000607000030000508000102200000086000097300910680070";
                var numericarray = [];
                for (var i = 0; i < initialstr.length; i++) {
                    numericarray.push(initialstr[i]);
                }

                // console.log(numericarray);
                loaddata(numericarray);
            }

            // SUDOKU FUNCTIONS ----------

            function initialise(doFullClear) {
                setStatus("Waiting for input");
                if (doFullClear) {
                    for (var i = 0; i < master.data.length; i++) {
                        master.data[i].value = 0;
                        master.data[i].mutable = true;
                        master.data[i].isHighlighted = false;
                    }
                } else {
                    for (var i = 0; i < master.data.length; i++) {
                        if (master.data[i].mutable) {
                            master.data[i].value = 0;
                            master.data[i].isHighlighted = false;
                        }
                    }
                }

                routeStack = [];
                selectedIndex = 0;
                backtracking = false;
            }

            function doCycle() {
                if (selectedIndex > master.data.length - 1) {
                    console.log("[+] Solution found");
                    setStatus("Solution found!");
                    stop(true);
                    document.getElementById("solvebtn").disabled = true;
                } else {
                    if (master.data[selectedIndex].mutable) {
                        if (backtracking) {
                            master.data[selectedIndex].value = master.data[selectedIndex].value + 1;
                        }
                        var val = master.data[selectedIndex].value;
                        while (((val < 9) && (!master.isValid())) || (val == 0)) {
                            master.data[selectedIndex].value = master.data[selectedIndex].value + 1;
                            val++;
                        }
                        if ((val < 10) && (master.isValid())) {
                            routeStack.push(selectedIndex);
                            master.data[selectedIndex].isHighlighted = true;
                            selectedIndex++;
                            backtracking = false;
                        } else {
                            // console.log("[-] Backtracking")
                            master.data[selectedIndex].value = 0;
                            master.data[selectedIndex].isHighlighted = false;
                            if (routeStack.length > 0) {
                                selectedIndex = routeStack.pop();
                                backtracking = true;
                            } else {
                                console.log("[-] No possible solution");
                                setStatus("No possible solutions.");
                                stop(true);
                            }
                        }
                    } else {
                        selectedIndex++;
                    }
                }
                master.render();
            }


            // BUTTON HANDLERS -------------
            function solve() {
                console.log("[*] Attempting a solve");
                setButtons(true, false, true, true, true, true);
                setStatus("Attempting a solve...");
                repeater = setInterval(doCycle, 10);
            }

            function stop(isComplete) {
                clearInterval(repeater);
                console.log("[*] Stopped");
                if (!isComplete) {
                    setStatus("Stopped");
                }
                setButtons(false, true, false, false, false, false);
            }

            function loadgrid() {
                console.log("[*] Opening load modal");
                document.getElementById("loadmodal").style.display = "block";
            }

            function exportgrid() {
                console.log("[*] Opening export modal");
                // Render image output
                document.getElementById("imgexport").src = canv.toDataURL("image/jpeg");
                // Render JSON output
                let jsondata = [];
                for (var i = 0; i < 9; i++) {
                    let row = [];
                    for (var j = 0; j < 9; j++) {
                        row.push(master.data[getIndex(j, i)].value);
                    }
                    jsondata.push(row);
                }
                document.getElementById("jsonexport").innerHTML = JSON.stringify(jsondata);
                // Render numeric output
                let numericdata = "";
                for (var i = 0; i < master.data.length; i++) {
                    numericdata = numericdata.concat(master.data[i].value);
                }
                document.getElementById("numericexport").innerHTML = numericdata;
                // Show modal
                document.getElementById("exportmodal").style.display = "block";
            }

            function clearattempt() {
                console.log("[*] Cleared attempt");
                initialise(false);
                setButtons(false, true, false, false, true, false);
                master.render();
            }

            function clearall() {
                console.log("[*] Cleared entire grid");
                initialise(true);
                setButtons(false, true, false, false, true, true);
                master.render();
            }

            function getinput() {
                const data = document.getElementById("loadtext").value;
                if (validateJSON(data)) {
                    // work with data as JSON
                    const jsondata = JSON.parse(data);
                    var numericarray = [];
                    for (var i = 0; i < jsondata.length; i++) {
                        numericarray.push(...jsondata[i]);
                    }

                    // console.log(numericarray);
                    loaddata(numericarray);
                } else if (validateNumeric(data)) {
                    var numericarray = [];
                    for (var i = 0; i < data.length; i++) {
                        numericarray.push(data[i]);
                    }

                    // console.log(numericarray);
                    loaddata(numericarray);
                } else {
                    console.log("[-] Invalid data");
                }
            }

            // PROGRAM ENTRY POINT HERE -----------
            var canv = document.getElementById("myCanvas");
            var ctx = canv.getContext("2d");
            var cellSize = canv.width / 9;

            var master = new SudokuGrid;

            var routeStack;
            var selectedIndex;
            var backtracking;
            initialise(true);

            var repeater;

            loadInitial();

            master.render();

            // When the user clicks anywhere outside of a the modal, close it
            // This can be commented out to force manual modal close
            window.onclick = function(event) {
                if ((event.target == document.getElementById("exportmodal")) || (event.target == document.getElementById("loadmodal"))) {
                    closeModals();
                }
            }

        </script>
    </body>
